<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Java集合对象的深复制与浅复制 | Hummingman</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js">   </script><!--script(type='text/javascript',src='/js/bk.js')  --><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><!--link(rel='stylesheet', href='/css/loading.css')--></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Java集合对象的深复制与浅复制</h1><a id="logo" href="/.">Hummingman</a><p class="description">Real Developer Ship...</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-send"> 总览</i></a><a href="/timeline/"><i class="fa fa-coffee"> 时光机</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Java集合对象的深复制与浅复制</h1><div class="post-meta">Oct 30, 2015<span> | </span><span class="category"><a href="/categories/Java/">Java</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> ℃</span></span><span> | </span><span>1,072</span><span>字</span><span> | </span><span>预计耗时</span><span>5</span><span>分钟 </span></div><a data-thread-key="cixiwn4fx000xdkn4l8xfr2va/" href="/cixiwn4fx000xdkn4l8xfr2va/#comments" class="ds-thread-count"></a><div class="post-content"><p>最近在开发中遇到了一些关于集合复制的一些问题，普通的集合复制只是将内存中栈的地址快拷贝一份，使得一个新的集合对象指向这个地址块，但是集合中的对象变量却是指向堆中的同一块区域。</p>
<a id="more"></a>
<p>所以当拷贝的集合修改了集合对象内的数据，那么源集合对象也就随之改变了，这样的效果我们称之为Java集合对象的浅复制，即只是在栈中拷贝了，而堆中的数据并没有拷贝。以下是Wiki上关于浅复制的定义： </p>
<blockquote>
<p>One method of copying an object is the shallow copy. In that case a new object B is created, and the fields values of A are copied over to B. If the field value is a reference to an object (e.g., a memory address) it copies the reference, hence referring to the same object as A does, and if the field value is a primitive type it copies the value of the primitive type. In languages without primitive types (where everything is an object), all fields of the copy B are references to the same objects as the fields of original A. The referenced objects are thus shared, so if one of these objects is modified (from A or B), the change is visible in the other. Shallow copies are simple and typically cheap, as they can be usually implemented by simply copying the bits exactly.  </p>
</blockquote>
<p>而深度复制则是同时在栈中和堆中的数据进行拷贝，这样，其拷贝的集合和被拷贝的集合已经没有任何关系了。同样，在Wiki上的定义如下：</p>
<blockquote>
<p>An alternative is a deep copy, meaning that fields are dereferenced: rather than references to objects being copied, new copy objects are created for any referenced objects, and references to these placed in B. The result is different from the result a shallow copy gives in that the objects referenced by the copy B are distinct from those referenced by A, and independent. Deep copies are more expensive, due to needing to create additional objects, and can be substantially more complicated, due to references possibly forming a complicated graph.</p>
</blockquote>
<h4 id="一个简单的例子"><a href="/cixiwn4fx000xdkn4l8xfr2va/#一个简单的例子" class="headerlink" title="一个简单的例子"></a>一个简单的例子</h4><p><strong>如下，建立一个Demo类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;  </div><div class="line">          </div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span>  demoValue;  </div><div class="line">          </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDemoValue</span><span class="params">(<span class="keyword">int</span> value)</span></span>&#123;  </div><div class="line">        <span class="keyword">this</span>.demoValue = value;  </div><div class="line">    &#125;  </div><div class="line">          </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDemoValue</span><span class="params">()</span></span>&#123;  </div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.demoValue;  </div><div class="line">    &#125;  </div><div class="line">          </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Demo</span><span class="params">()</span></span>&#123;  </div><div class="line">              </div><div class="line">    &#125;  </div><div class="line">          </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Demo</span><span class="params">(<span class="keyword">int</span> demoValue)</span></span>&#123;  </div><div class="line">        <span class="keyword">this</span>.demoValue = demoValue;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>接下来，我们试验一下浅复制：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span>  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCommonCopy</span><span class="params">()</span> </span>&#123;  </div><div class="line">  </div><div class="line">    <span class="comment">// Here I create a source collection.  </span></div><div class="line">    ArrayList&lt;Demo&gt; sourceCollection = <span class="keyword">new</span> ArrayList&lt;Demo&gt;();  </div><div class="line">  </div><div class="line">    <span class="comment">// Here I add some objects to sourceCollection.  </span></div><div class="line">    sourceCollection.add(<span class="keyword">new</span> Demo(<span class="number">1</span>));  </div><div class="line">    sourceCollection.add(<span class="keyword">new</span> Demo(<span class="number">2</span>));  </div><div class="line">  </div><div class="line">    <span class="comment">// Here I create a new empty collection.  </span></div><div class="line">    ArrayList&lt;Demo&gt; newCollection = <span class="keyword">new</span> ArrayList&lt;Demo&gt;();  </div><div class="line">    newCollection.addAll(sourceCollection);  </div><div class="line">  </div><div class="line">    <span class="comment">// Now I modify some objects in new collection.  </span></div><div class="line">    newCollection.get(<span class="number">0</span>).setDemoValue(<span class="number">3</span>);  </div><div class="line">      </div><div class="line">    <span class="comment">// Now We verify what it is inside the source collection.  </span></div><div class="line">    <span class="keyword">for</span>(Demo demo : sourceCollection)&#123;  </div><div class="line">        System.out.println(demo.getDemoValue());  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    <span class="comment">// Now I verify if the source Collection is modified.  </span></div><div class="line">    Assert.assertEquals(sourceCollection.get(<span class="number">0</span>).getDemoValue(),<span class="number">1</span>);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://p1.bqimg.com/577934/10a8c49f1aa0ffab.png" alt="若加载不了，请自行意会"></p>
<p>对其的执行结果，很明显，newCollection中改变的Demo对象在SourceCollection中也跟着改变了，这说明两个集合中的Demo对象是同一个对象。这也是浅复制所存在的弊端。那么如何将两个集合独立开来呢，即如何进行深度复制，我们不妨继续往下阅读：</p>
<p><strong>首先我们先对Demo类作一下处理，使其实现Cloneable接口，并重写它的clone方法：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> Demo <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;             </div><div class="line">	<span class="keyword">return</span> (Demo)<span class="keyword">super</span>.clone(); </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>然后我们来进行深度复制：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span>  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCopyDeep</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;  </div><div class="line">    ArrayList&lt;Demo&gt; sourceCollection = <span class="keyword">new</span> ArrayList&lt;Demo&gt;();  </div><div class="line">    sourceCollection.add(<span class="keyword">new</span> Demo(<span class="number">1</span>));  </div><div class="line">    sourceCollection.add(<span class="keyword">new</span> Demo(<span class="number">2</span>));    </div><div class="line">      </div><div class="line">    ArrayList&lt;Demo&gt; newCollection = <span class="keyword">new</span> ArrayList&lt;Demo&gt;();  </div><div class="line">    <span class="keyword">for</span>(Demo demo : sourceCollection)&#123;  </div><div class="line">        newCollection.add(demo.clone());  </div><div class="line">    &#125;  </div><div class="line">    newCollection.get(<span class="number">0</span>).setDemoValue(<span class="number">3</span>);  </div><div class="line">    <span class="keyword">for</span>(Demo demo : sourceCollection)&#123;  </div><div class="line">        System.out.println(demo.getDemoValue());  </div><div class="line">    &#125;  </div><div class="line">    Assert.assertEquals(sourceCollection.get(<span class="number">0</span>).getDemoValue(),<span class="number">1</span>);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后我们来观察一下结果：搞定</p>
<p><img src="http://p1.bqimg.com/577934/056713396d470fb5.png" alt="若加载不了，请自行意会"></p>
<p><strong>接下来我们来分析一下出现这个现象的原因：</strong></p>
<p><strong>深度复制：</strong> 如图：A中具有X1,X2,X3…Xn的数据，深度复制则对其每个堆和栈中的数据都进行一次拷贝，生成对应的Y1,Y2,Y3以及B对象。此时，A与B已经分别存放在不同的地址单元，所以A中改了数据，B中的数据不变，反之亦然。<br><strong>浅复制：</strong> 如图：A复制成B，但是A和B中的数据均指向同一个X1,X2,X3…Xn，所以当A通过某种方法改变了数据，对于B来说，其中的数据也改变了。</p>
<p>最后，给大家推荐一下Wiki上的关于对象复制的文章，<a href="https://en.wikipedia.org/wiki/Object_copying。" target="_blank" rel="external">https://en.wikipedia.org/wiki/Object_copying。</a><br>也给大家推荐一下我的个人博客，虽然已经好久没有更新了。<a href="http://andersonlu.github.io/ALBOG/" target="_blank" rel="external">http://andersonlu.github.io/ALBOG/</a><br>同时也希望大家能够在本篇文章中收益，感谢大家的阅读。记得点赞哦！</p>
</div><div class="tags"><a href="/tags/Java/">Java</a></div><div class="post-nav"><a href="/cixiwn4fi000cdkn43hvd46p7/" class="pre">Java ConcurrentModificationException</a><a href="/cixiwn4gw002fdkn4dkb2b85o/" class="next">菜鸟学Linux之基本命令</a></div><div data-thread-key="cixiwn4fx000xdkn4l8xfr2va/" data-title="Java集合对象的深复制与浅复制" data-url="/cixiwn4fx000xdkn4l8xfr2va/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="cixiwn4fx000xdkn4l8xfr2va/" data-title="Java集合对象的深复制与浅复制" data-url="/cixiwn4fx000xdkn4l8xfr2va/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="站内搜索..." type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-globe"> 访问地图</i><div style="padding-top:5px"></div></div><script type="text/javascript" src="//rc.revolvermaps.com/0/0/8.js?i=2ci0ian43hc&amp;m=0&amp;s=220&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33" async="async"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-plus-square-o"> 文章分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ASP-Net/">ASP.Net</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/">Database</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Front-end/">Front-end</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/GWT/">GWT</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JQuery/">JQuery</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/REST/">REST</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Software-Engineering/">Software Engineering</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tool/">Tool</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/游戏/">游戏</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/阅读/">阅读</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a><span class="category-list-count">5</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-hand-grab-o"> 文章标签</i></div><div class="tagcloud"><a href="/tags/Javascript/" style="font-size: 15px;">Javascript</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/Front-end/" style="font-size: 15px;">Front-end</a> <a href="/tags/JSON/" style="font-size: 15px;">JSON</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/ASP-net/" style="font-size: 15px;">ASP.net</a> <a href="/tags/Software-Engineering/" style="font-size: 15px;">Software Engineering</a> <a href="/tags/Game/" style="font-size: 15px;">Game</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Ubuntu/" style="font-size: 15px;">Ubuntu</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/JQuery/" style="font-size: 15px;">JQuery</a> <a href="/tags/GWT/" style="font-size: 15px;">GWT</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/REST/" style="font-size: 15px;">REST</a> <a href="/tags/MongoDB/" style="font-size: 15px;">MongoDB</a> <a href="/tags/Database/" style="font-size: 15px;">Database</a> <a href="/tags/Tool/" style="font-size: 15px;">Tool</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/Fidder/" style="font-size: 15px;">Fidder</a> <a href="/tags/读书笔记/" style="font-size: 15px;">读书笔记</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-code-fork"> 最新发布</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/cixiwn4fv000vdkn4tolnai79/">X:Rebirth Home Of Light Guide</a></li><li class="post-list-item"><a class="post-list-link" href="/cixiwn4g10013dkn450ca1kxb/">致X君</a></li><li class="post-list-item"><a class="post-list-link" href="/cixiwn4h60032dkn48rk5205l/">随笔集</a></li><li class="post-list-item"><a class="post-list-link" href="/cixiwn4h70036dkn4o0ufup1y/">软件开发原则</a></li><li class="post-list-item"><a class="post-list-link" href="/cixiwn4gz002ndkn4yt15c2yv/">试试Reids之基础知识</a></li><li class="post-list-item"><a class="post-list-link" href="/cixiwn4h50030dkn4i5atwiz6/">试试Redis之环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/cixiwn4h3002vdkn44xpr959c/">WEB系统性能调优之路</a></li><li class="post-list-item"><a class="post-list-link" href="/cixiwn4go0022dkn4kn3cub2r/">程序猿百宝箱(持续更新)</a></li><li class="post-list-item"><a class="post-list-link" href="/cixiwn4gj001wdkn4f8rlep5y/">玩转MongoDB之备份与恢复</a></li><li class="post-list-item"><a class="post-list-link" href="/cixiwn4gu002adkn4u178xyof/">玩转MongoDB之权限控制</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-link"> 更多链接</i></div><ul></ul><a href="https://hexo.io/zh-cn/docs/asset-folders.html" title="&lt;Hexo&gt; Official Hexo Guide" target="_blank">&lt;Hexo&gt; Official Hexo Guide</a><ul></ul><a href="https://github.com/tufu9441/maupassant-hexo" title="&lt;Hexo&gt; Maupassant Guide" target="_blank">&lt;Hexo&gt; Maupassant Guide</a></div><div class="widget"><div class="widget-title"><i class="fa fa-globe"> 小小天地</i></div><ul><a href="/music/s.html" title="我所以为的音乐&amp;你所以为的音乐">音乐，是另一种深情</a></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© 2016 <a href="/." rel="nofollow">Hummingman.</a> Maintain by Anderson.</div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'hummingman'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>